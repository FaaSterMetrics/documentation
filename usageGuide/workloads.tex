\documentclass[../main.tex]{subfiles}
\begin{document}


\section{Usage Guide: Workloads}\label{sec:WorkloadsUsage}

As we defined in the section BLUBB we are using artillery to run workloads on experiments.   % TODO: Design Principles->Experiment Structure->Workloads reference

In conclusion for setup you need to place your workload in the \\
\texttt{experiments/EXPERIMENT\_NAME/} 
folder and edit the \texttt{experiment.json} file to reference the workload by filename.
\begin{tcolorbox}[titleDetachedStyle, title=\texttt{experiment.json}]
\begin{minted}{js}
...
  "services": {
    "workload": {
      "config": "./workload.yml"
    }, ...
...
\end{minted}
\end{tcolorbox}

The \href{https://artillery.io/docs/}{official artillery docs} can be referenced for how to structure the workloads. Be sure to set the \texttt{processor} in the header to \\\textt{'\{\{ \$processEnvironment.PROCESSOR\_DIR \}\}/logger.js'} and set the \texttt{beforeRequest, afterResponse} as in the example  for every request. 



To call a function with an rpc handler your request in artillery needs to look something like this:

\begin{tcolorbox}[titleDetachedStyle, title=\texttt{workload.yml}]
\begin{minted}{yaml}
- post:
  url: '{{ functioname }}/call'
  json:
    arg1: 'blubb' 
    arg2: 'blabb'
  beforeRequest: 'beforeRequest'
  afterResponse: 'afterResponse'
\end{minted}
\end{tcolorbox}

\texttt{'\{\{ functionname \}\}'} will automatically resolve to the base url of function \texttt{functionname}.

After this is configured and your experiment is built and deployed you can run \texttt{fmctl workload EXPERIMENT\_NAME} which will automatically provision a vps on AWS and run your workload on it, automatically fetching the logs back to your computer for later analysis. After this the server-instance will be automatically be destroyed.

You may wish to extend artillery functionality with javascript functions, for this please edit the \texttt{artillery/logger.js} file according to the artillery documentation.


\end{document}